#cloud-config
system_info:
  default_user:
    name: ${vm_admin}
    
#
# First we'll update the repo and then update the OS.
#
package_update: true
package_upgrade: true

#
# Install packages
#
packages:
  - nfs-common

#
# Add nfs mounts
#
runcmd:
  - if ! [ -z "${rwx_filestore_endpoint}" ]
  - then
      #
      # Update /etc/fstab
      #
  -   MOUNT="${rwx_filestore_endpoint}:${rwx_filestore_path} ${jump_rwx_filestore_path} nfs _netdev,auto,x-systemd.automount,x-systemd.mount-timeout=10,timeo=14,x-systemd.idle-timeout=1min,relatime,hard,rsize=65536,wsize=65536,vers=3,tcp,namlen=255,retrans=2,sec=sys,local_lock=none 0 0"
  -   grep -q "$MOUNT" /etc/fstab || echo "$MOUNT" | tee -a /etc/fstab
      #
      # mount the nfs
      #
  -   mkdir -p ${jump_rwx_filestore_path}
  -   while [ `df -h | grep "${rwx_filestore_endpoint}:${rwx_filestore_path}" | wc -l` -eq 0 ]; do sleep 5 && mount -a ; done
      #
      # Change permissions and owener
      #
  -   mkdir -p ${jump_rwx_filestore_path}/pvs
  -   $(chmod -fR 777 ${jump_rwx_filestore_path} ; echo)
  -   $(chown -R nobody:nogroup ${jump_rwx_filestore_path} ; echo)
  - fi
